<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Block Escape</title>
<style>
body {
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #111;
    color: #0ff;
    font-family: monospace;
    flex-direction: column;
}
#gameCanvas {
    background: #222;
    border: 2px solid #0ff;
    border-radius: 10px;
}
#gameInfo { 
    margin-bottom: 10px; 
    font-size: 18px;
}
#gameOver, #levelMenu {
    position: absolute;
    top: 0; 
    left: 0;
    width: 100%; 
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.9);
    color: #0ff;
    font-size: 24px;
}
button {
    margin: 10px;
    padding: 12px 25px;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    background: #0ff;
    color: #111;
    cursor: pointer;
}
button:hover { 
    background: #0aa; 
}
#levelGrid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-top: 20px;
}
</style>
</head>
<body>

<div id="gameInfo"></div>
<canvas id="gameCanvas" width="500" height="300"></canvas>

<div id="gameOver" style="display:none;">
    <div id="resultMessage"></div>
    <button onclick="restartGame()">Try Again</button>
    <button id="nextLevelBtn" onclick="goNextLevel()">Next Level</button>
    <button onclick="goToDashboard()">Back to Dashboard</button>
</div>

<div id="levelMenu">
    <h2>Choose Your Level</h2>
    <div id="levelGrid"></div>
    <button onclick="goToDashboard()" style="margin-top: 20px;">Back to Dashboard</button>
</div>

<script>
// Check if user is logged in
var currentUser = localStorage.getItem('currentUser');
if(!currentUser){
    alert('Please login first!');
    window.location.href = './login.html';
}

var canvas = document.getElementById('gameCanvas');
var drawing = canvas.getContext('2d');

var playerX = 20;
var playerY = 20;
var playerSize = 20;
var playerSpeed = 2;
var moveX = 0;
var moveY = 0;

var currentLevel = 1;
var isWon = false;
var isDead = false;
var playerScore = 0;
var gameStartTime = 0;

var allLevels = [
    {
        finish: {x: 440, y: 240, width: 40, height: 40}, 
        walls: [{x: 150, y: 50, width: 20, height: 200}]
    },
    {
        finish: {x: 440, y: 20, width: 40, height: 40}, 
        walls: [{x: 100, y: 100, width: 20, height: 150}, {x: 250, y: 0, width: 20, height: 150}]
    },
    {
        finish: {x: 440, y: 240, width: 40, height: 40}, 
        walls: [{x: 100, y: 50, width: 20, height: 200}, {x: 200, y: 0, width: 20, height: 150}, {x: 300, y: 100, width: 20, height: 150}]
    },
    {
        finish: {x: 440, y: 240, width: 40, height: 40}, 
        walls: [{x: 50, y: 100, width: 20, height: 200}, {x: 150, y: 0, width: 20, height: 150}, {x: 250, y: 100, width: 20, height: 150}, {x: 350, y: 0, width: 20, height: 150}]
    },
    {
        finish: {x: 440, y: 20, width: 40, height: 40}, 
        walls: [{x: 80, y: 50, width: 20, height: 250}, {x: 180, y: 0, width: 20, height: 150}, {x: 280, y: 100, width: 20, height: 150}, {x: 380, y: 50, width: 20, height: 250}]
    },
    {
        finish: {x: 440, y: 240, width: 40, height: 40}, 
        walls: [{x: 50, y: 0, width: 20, height: 150}, {x: 150, y: 100, width: 20, height: 200}, {x: 250, y: 0, width: 20, height: 150}, {x: 350, y: 100, width: 20, height: 200}]
    },
    {
        finish: {x: 440, y: 20, width: 40, height: 40}, 
        walls: [{x: 50, y: 50, width: 20, height: 200}, {x: 150, y: 0, width: 20, height: 150}, {x: 250, y: 100, width: 20, height: 150}, {x: 350, y: 50, width: 20, height: 200}]
    },
    {
        finish: {x: 440, y: 240, width: 40, height: 40}, 
        walls: [{x: 60, y: 0, width: 20, height: 150}, {x: 160, y: 100, width: 20, height: 200}, {x: 260, y: 0, width: 20, height: 150}, {x: 360, y: 100, width: 20, height: 200}]
    },
    {
        finish: {x: 440, y: 20, width: 40, height: 40}, 
        walls: [{x: 40, y: 50, width: 20, height: 200}, {x: 140, y: 0, width: 20, height: 150}, {x: 240, y: 100, width: 20, height: 150}, {x: 340, y: 50, width: 20, height: 200}]
    },
    {
        finish: {x: 440, y: 240, width: 40, height: 40}, 
        walls: [{x: 50, y: 0, width: 20, height: 150}, {x: 150, y: 100, width: 20, height: 200}, {x: 250, y: 0, width: 20, height: 150}, {x: 350, y: 100, width: 20, height: 200}, {x: 200, y: 50, width: 20, height: 200}]
    }
];

var levelButtonContainer = document.getElementById('levelGrid');
for (var i = 1; i <= 10; i++) {
    var btn = document.createElement('button');
    btn.innerText = 'Level ' + i;
    btn.onclick = (function(levelNum) {
        return function() {
            currentLevel = levelNum;
            document.getElementById('levelMenu').style.display = 'none';
            startGame();
        };
    })(i);
    levelButtonContainer.appendChild(btn);
}

function startGame() {
    playerX = 20;
    playerY = 20;
    moveX = 0;
    moveY = 0;
    isWon = false;
    isDead = false;
    playerScore = 0;
    gameStartTime = Date.now();
    document.getElementById('gameOver').style.display = 'none';
}

function restartGame() {
    startGame();
}

function goNextLevel() {
    if (currentLevel < 10) {
        currentLevel++;
        startGame();
    }
}

function goToDashboard() {
    window.location.href = './dashboard.html';
}

function updateGameInfo() {
    document.getElementById('gameInfo').innerHTML = 'Level: <b>' + currentLevel + '</b> | Score: <b>' + playerScore + '</b> | Player: <b>' + currentUser + '</b>';
}

function gameLoop() {
    if (document.getElementById('levelMenu').style.display !== 'none') {
        requestAnimationFrame(gameLoop);
        return;
    }

    if (!isWon && !isDead) {
        playerX = playerX + moveX;
        playerY = playerY + moveY;

        if (playerX < 0) playerX = 0;
        if (playerX > canvas.width - playerSize) playerX = canvas.width - playerSize;
        if (playerY < 0) playerY = 0;
        if (playerY > canvas.height - playerSize) playerY = canvas.height - playerSize;

        var timeElapsed = Date.now() - gameStartTime;
        playerScore = 1000 - Math.floor(timeElapsed / 10);
        if (playerScore < 0) playerScore = 0;
    }

    drawing.clearRect(0, 0, canvas.width, canvas.height);

    var thisLevel = allLevels[currentLevel - 1];

    drawing.fillStyle = 'green';
    drawing.fillRect(thisLevel.finish.x, thisLevel.finish.y, thisLevel.finish.width, thisLevel.finish.height);

    drawing.fillStyle = 'red';
    for (var i = 0; i < thisLevel.walls.length; i++) {
        var wall = thisLevel.walls[i];
        drawing.fillRect(wall.x, wall.y, wall.width, wall.height);
    }

    if (isDead) {
        drawing.fillStyle = '#555';
    } else {
        drawing.fillStyle = '#0ff';
    }
    drawing.fillRect(playerX, playerY, playerSize, playerSize);

    for (var i = 0; i < thisLevel.walls.length; i++) {
        var wall = thisLevel.walls[i];
        if (playerX < wall.x + wall.width && 
            playerX + playerSize > wall.x && 
            playerY < wall.y + wall.height && 
            playerY + playerSize > wall.y) {
            isDead = true;
            playerScore = 0;
        }
    }

    if (playerX < thisLevel.finish.x + thisLevel.finish.width && 
        playerX + playerSize > thisLevel.finish.x && 
        playerY < thisLevel.finish.y + thisLevel.finish.height && 
        playerY + playerSize > thisLevel.finish.y) {
        isWon = true;
    }

    if (isWon) {
        var leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
        var index = leaderboard.findIndex(function(p) { 
            return p.username === currentUser && p.level === currentLevel; 
        });
        
        if(index >= 0){
            if(playerScore > leaderboard[index].score) {
                leaderboard[index].score = playerScore;
            }
        } else {
            leaderboard.push({username: currentUser, score: playerScore, level: currentLevel});
        }
        
        leaderboard.sort(function(x,y){ return y.score - x.score; });
        localStorage.setItem('leaderboard', JSON.stringify(leaderboard));

        document.getElementById('gameOver').style.display = 'flex';
        document.getElementById('resultMessage').innerText = 'You Won! Score: ' + playerScore;
        document.getElementById('nextLevelBtn').style.display = 'inline-block';
    }

    if (isDead) {
        document.getElementById('gameOver').style.display = 'flex';
        document.getElementById('resultMessage').innerText = 'You Died! Score: ' + playerScore;
        document.getElementById('nextLevelBtn').style.display = 'none';
    }

    updateGameInfo();
    requestAnimationFrame(gameLoop);
}

gameLoop();

document.onkeydown = function(e) {
    if (!isWon && !isDead && document.getElementById('levelMenu').style.display === 'none') {
        if (e.key == 'ArrowLeft') moveX = -playerSpeed;
        if (e.key == 'ArrowRight') moveX = playerSpeed;
        if (e.key == 'ArrowUp') moveY = -playerSpeed;
        if (e.key == 'ArrowDown') moveY = playerSpeed;
    }
};

document.onkeyup = function(e) {
    if (e.key.startsWith('Arrow')) {
        moveX = 0;
        moveY = 0;
    }
};
</script>

</body>
</html>